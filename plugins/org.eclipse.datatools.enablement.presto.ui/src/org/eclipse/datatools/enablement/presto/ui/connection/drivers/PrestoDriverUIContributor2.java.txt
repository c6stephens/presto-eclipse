package org.eclipse.datatools.enablement.presto.ui.connection.drivers;

import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

import org.eclipse.datatools.connectivity.drivers.jdbc.IJDBCConnectionProfileConstants;
import org.eclipse.datatools.connectivity.drivers.jdbc.IJDBCDriverDefinitionConstants;
import org.eclipse.datatools.connectivity.internal.ui.ConnectivityUIPlugin;
import org.eclipse.datatools.connectivity.ui.wizards.IDriverUIContributor;
import org.eclipse.datatools.connectivity.ui.wizards.IDriverUIContributorInformation;
import org.eclipse.datatools.connectivity.ui.wizards.OptionalPropertiesPane;
import org.eclipse.jface.dialogs.DialogPage;
import org.eclipse.swt.SWT;
import org.eclipse.swt.custom.ScrolledComposite;
import org.eclipse.swt.layout.GridData;
import org.eclipse.swt.layout.GridLayout;
import org.eclipse.swt.widgets.Button;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Event;
import org.eclipse.swt.widgets.Label;
import org.eclipse.swt.widgets.Listener;
import org.eclipse.swt.widgets.TabFolder;
import org.eclipse.swt.widgets.TabItem;
import org.eclipse.swt.widgets.Text;

public class PrestoDriverUIContributor2 implements IDriverUIContributor,
		Listener {
	
	private ScrolledComposite scrolledComposite = null;

	protected Text hostText;
	protected Text portText;
	protected Text catalogText;
	protected Text schemaText;
	protected Text usernameText;

	protected OptionalPropertiesPane optionalPropsComposite;

	private IDriverUIContributorInformation contributorInformation;

	private Properties properties;

	protected DialogPage parentPage;
	
	protected boolean isReadOnly = false;

	
	private Text addTextField(Composite composite, String labelString) {
		
		int additionalStyles = isReadOnly ? SWT.READ_ONLY : SWT.NONE;
		
		Label label = new Label(composite, SWT.NULL);
		label.setLayoutData(new GridData());
		label.setText(labelString);

		Text text = new Text(composite, SWT.BORDER | additionalStyles);
		text.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));
		
		return text;
	}
	
	public Composite getContributedDriverUI(Composite parent, boolean isReadOnly) {
		
		if ((scrolledComposite == null) || scrolledComposite.isDisposed() || (this.isReadOnly != isReadOnly)) {
			this.isReadOnly = isReadOnly;
			
			scrolledComposite = new ScrolledComposite(parent, SWT.H_SCROLL|SWT.V_SCROLL);
			scrolledComposite.setExpandHorizontal(true);
			scrolledComposite.setExpandVertical(true);
			scrolledComposite.setLayout(new GridLayout());

			TabFolder parentComposite = new TabFolder(scrolledComposite, SWT.TOP);

			TabItem generalTab = new TabItem(parentComposite, SWT.None);
			generalTab.setText("General");

			TabItem optionalTab = new TabItem(parentComposite, SWT.None);
			optionalTab.setText("Optional");
            
			optionalPropsComposite = new OptionalPropertiesPane(parentComposite, SWT.NULL, isReadOnly);
            optionalTab.setControl(optionalPropsComposite);

			Composite generalComposite = new Composite(parentComposite, SWT.NULL);
			GridLayout layout = new GridLayout();
			layout.numColumns = 2;
			generalComposite.setLayout(layout);
			generalTab.setControl(generalComposite);

			hostText     = addTextField(generalComposite, "Host");
			portText     = addTextField(generalComposite, "Port");
			catalogText  = addTextField(generalComposite, "Catalog");
			schemaText   = addTextField(generalComposite, "Schema");
			usernameText = addTextField(generalComposite, "Username");
			
			scrolledComposite.setContent(parentComposite);
			scrolledComposite.setMinSize(parentComposite.computeSize(SWT.DEFAULT, SWT.DEFAULT));
			initialize();
		}
		
		return scrolledComposite;
	}

	public void setConnectionInformation() {
		properties.setProperty(
				IJDBCDriverDefinitionConstants.DATABASE_NAME_PROP_ID,
				this.databaseNameText.getText().trim());
		properties.setProperty(IJDBCDriverDefinitionConstants.PASSWORD_PROP_ID,
				this.passwordText.getText());
		properties.setProperty(IJDBCDriverDefinitionConstants.USERNAME_PROP_ID,
				this.usernameText.getText());
		properties.setProperty(
				IJDBCConnectionProfileConstants.SAVE_PASSWORD_PROP_ID, String
						.valueOf(savePasswordButton.getSelection()));
		properties.setProperty(IJDBCDriverDefinitionConstants.URL_PROP_ID,
				this.urlText.getText().trim());
        optionalPropsComposite.setConnectionInformation();

        this.contributorInformation.setProperties(properties);
	}

	private void removeListeners() {
		databaseNameText.removeListener(SWT.Modify, this);
		urlText.removeListener(SWT.Modify, this);
		usernameText.removeListener(SWT.Modify, this);
		passwordText.removeListener(SWT.Modify, this);
		savePasswordButton.removeListener(SWT.Selection, this);
	}

	private void addListeners() {
		databaseNameText.addListener(SWT.Modify, this);
		urlText.addListener(SWT.Modify, this);
		usernameText.addListener(SWT.Modify, this);
		passwordText.addListener(SWT.Modify, this);
		savePasswordButton.addListener(SWT.Selection, this);
	}

	private void initialize() {
		addListeners();
	}

	public void handleEvent(Event event) {
		if (isReadOnly){
			if (event.widget == savePasswordButton){
				savePasswordButton.setSelection(!savePasswordButton.getSelection());
			}
		} else {
			setConnectionInformation();
		}
	}

	public boolean determineContributorCompletion() {
		boolean isComplete = true;
		if (databaseNameText.getText().trim().length() < 1) {
			parentPage
					.setErrorMessage(ConnectivityUIPlugin
							.getDefault()
							.getResourceString(
									"OtherDriverUIContributor.errormessage.requiresdatabase")); //$NON-NLS-1$
			isComplete = false;
		} else if (urlText.getText().trim().length() < 1) {
			parentPage
					.setErrorMessage(ConnectivityUIPlugin
							.getDefault()
							.getResourceString(
									"OtherDriverUIContributor.errormessage.requiresurl")); //$NON-NLS-1$
			isComplete = false;
		} else if (usernameText.getText().trim().length() < 1) {
			parentPage
					.setErrorMessage(ConnectivityUIPlugin
							.getDefault()
							.getResourceString(
									"OtherDriverUIContributor.errormessage.requiresusername")); //$NON-NLS-1$
			isComplete = false;
        } else if (!optionalPropsComposite.validateControl(parentPage)) {
            isComplete = false;
        } 

		if (isComplete) {
			parentPage.setErrorMessage(null);
		}
		return isComplete;
	}

	public void setDialogPage(DialogPage parentPage) {
		this.parentPage = parentPage;
	}

	public void setDriverUIContributorInformation(
			IDriverUIContributorInformation contributorInformation) {
		this.contributorInformation = contributorInformation;
		this.properties = contributorInformation.getProperties();
        optionalPropsComposite.setDriverUIContributorInformation( contributorInformation );
	}

	public void loadProperties() {
		removeListeners();

		String databaseName = this.properties.getProperty(IJDBCDriverDefinitionConstants.DATABASE_NAME_PROP_ID);
		
		if (databaseName != null) {
			databaseNameText.setText(databaseName);
		}

		String url = this.properties
				.getProperty(IJDBCDriverDefinitionConstants.URL_PROP_ID);
		if (url != null) {
			urlText.setText(url);
		}

		String username = this.properties
				.getProperty(IJDBCDriverDefinitionConstants.USERNAME_PROP_ID);
		if (username != null) {
			usernameText.setText(username);
		}

		String password = this.properties
				.getProperty(IJDBCDriverDefinitionConstants.PASSWORD_PROP_ID);
		if (password != null) {
			passwordText.setText(password);
		}

		String savePassword = this.properties
				.getProperty(IJDBCConnectionProfileConstants.SAVE_PASSWORD_PROP_ID);
		if ((savePassword != null)
				&& Boolean.valueOf(savePassword) == Boolean.TRUE) {
			savePasswordButton.setSelection(true);
		}

        // load optional connection properties
        optionalPropsComposite.loadProperties();

		addListeners();
		setConnectionInformation();
	}

	@SuppressWarnings({ "rawtypes", "unchecked" })
	public List getSummaryData() {
		List summaryData = new ArrayList();
		summaryData.add(new String[] {
				ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.database"),
				this.databaseNameText.getText().trim()
			});
		summaryData.add(new String[] {
				ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.username"),
				this.usernameText.getText().trim()
			});
		summaryData.add(new String[] {
				ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.url"),
				this.urlText.getText().trim()
			});
		summaryData.add(new String[] {
				ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.savePassword"),
				savePasswordButton.getSelection() ? ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.true")
                                                  : ConnectivityUIPlugin.getDefault().getResourceString("OtherDriverUIContributor.summaryData.false")
			});
		return summaryData;
	}

}